#!/bin/bash

set -e

# For help customizing this script, read:
# http://tiny/a6md3511/Third-Party_custom-build

SRC_DIR=`pwd`
BUILD_DIR="$SRC_DIR/build"
WRITABLE_SRC_DIR="$BUILD_DIR/private/src"
INSTALL_DIR="$BUILD_DIR/private/install"

echo "Getting configuration values from Brazil"
eval "$(cflags -format sh)"
# Add calls to brazil-path here to get other configure options

echo "Copying source code into writable location"
mkdir -p "$WRITABLE_SRC_DIR"
cp -rufp "$SRC_DIR"/* "$WRITABLE_SRC_DIR"
# Special handling of filenames reserved by Brazil
rm -rf "$WRITABLE_SRC_DIR/Config" "$WRITABLE_SRC_DIR/build" "$WRITABLE_SRC_DIR/build-tools"

echo "Running third-party build"
mkdir -p "$INSTALL_DIR"
cd "$WRITABLE_SRC_DIR"
./configure "--prefix=$INSTALL_DIR"
make
make install

echo "Copying install artifacts to Brazil locations"
cd "$SRC_DIR"
cp -rf "$INSTALL_DIR"/* "$BUILD_DIR"
